From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Shelley Vohr <shelley.vohr@gmail.com>
Date: Tue, 21 Oct 2025 20:00:06 +0200
Subject: fix: allow disabling fetch in renderer and worker processes

We need to disable Node.js' fetch implementation to prevent
conflict with Blink's in renderer and worker processes.

We should try to upstream some version of this.

diff --git a/lib/internal/process/pre_execution.js b/lib/internal/process/pre_execution.js
index 35b43990c8f24f0888f89173f5662050a11b26ed..2c0d12c0fa9c85ac7ffb41dabda83760ed1ae3ee 100644
--- a/lib/internal/process/pre_execution.js
+++ b/lib/internal/process/pre_execution.js
@@ -110,6 +110,7 @@ function prepareExecution(options) {
   setupSQLite();
   setupQuic();
   setupWebStorage();
+  setupFetch();
   setupWebsocket();
   setupEventsource();
   setupCodeCoverage();
@@ -312,6 +313,16 @@ function setupWarningHandler() {
   }
 }
 
+function setupFetch() {
+  if (getOptionValue('--no-experimental-fetch')) {
+    delete globalThis.fetch;
+    delete globalThis.FormData;
+    delete globalThis.Headers;
+    delete globalThis.Request;
+    delete globalThis.Response;
+  }
+}
+
 // https://websockets.spec.whatwg.org/
 function setupWebsocket() {
   if (getOptionValue('--no-experimental-websocket')) {
diff --git a/src/node_options.cc b/src/node_options.cc
index 2a3ab5e73cdb98bde9df1465d5fb5e40ad7799f7..9317191d22f51fd75157e849eb67678d1ee6a2a1 100644
--- a/src/node_options.cc
+++ b/src/node_options.cc
@@ -537,7 +537,11 @@ EnvironmentOptionsParser::EnvironmentOptionsParser() {
             &EnvironmentOptions::experimental_eventsource,
             kAllowedInEnvvar,
             false);
-  AddOption("--experimental-fetch", "", NoOp{}, kAllowedInEnvvar);
+  AddOption("--experimental-fetch",
+            "experimental Fetch API",
+            &EnvironmentOptions::experimental_fetch,
+            kAllowedInEnvvar,
+            true);
   AddOption("--experimental-websocket",
             "experimental WebSocket API",
             &EnvironmentOptions::experimental_websocket,
